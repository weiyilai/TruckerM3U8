<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETS2 Dashboard & Radio</title>
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.7/signalr.min.js"></script>
    <style>

        .glass {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .speedo-font {
            font-family: 'Oxanium', sans-serif;
        }

        .gauge-ring {
            transition: stroke-dashoffset 0.1s linear;
        }

        .warning-light {
            font-size: 1.5rem;
            color: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        .light-on-green { color: var(--truck-green); filter: drop-shadow(0 0 5px var(--truck-green)); }
        .light-on-blue { color: var(--truck-blue); filter: drop-shadow(0 0 5px var(--truck-blue)); }
        .light-on-red { color: var(--truck-red); filter: drop-shadow(0 0 5px var(--truck-red)); }

        .indicator-active {
            filter: drop-shadow(0 0 8px var(--truck-green));
            color: var(--truck-green) !important;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .progress-bar {
            height: 8px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        #playlist-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 50;
            align-items: center;
            justify-content: center;
        }

        .widget-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--truck-orange);
            padding-left: 0.5rem;
        }

        /* === Fixed-viewport scaling (reference: 1200√ó800, 3:2) === */
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
        }
        #viewport {
            width: 1200px;
            height: 800px;
            padding: 24px;
            transform-origin: top left;
            position: absolute;
            top: 0; left: 0;
        }
    </style>
</head>
<body id="app-body">
    <!-- Tailwind CDN safelist: cargo card dynamic colors -->
    <div class="hidden
        border-orange-500/20 border-emerald-500/20 border-red-500/20
        border-orange-500/30 border-emerald-500/30 border-red-500/30
        text-orange-400 text-emerald-400 text-red-400
        text-orange-500 text-emerald-500 text-red-500
        bg-orange-500/10 bg-emerald-500/10 bg-red-500/10
    "></div>

    <div id="viewport">
    <div class="flex-1 grid grid-cols-12 gap-6 max-w-7xl mx-auto w-full">
        
        <!-- LHS ÂÑÄË°®ÊùøÂçÄ -->
        <div class="col-span-5 glass p-6 flex flex-col items-center justify-between">
            <!-- ÊñπÂêëÁáà -->
            <div class="flex justify-between w-full px-8 mb-2">
                <span id="indicator-left" class="text-6xl text-slate-700">‚¨Ö</span>
                <span id="indicator-right" class="text-6xl text-slate-700">‚û°</span>
            </div>

            <!-- ËΩâÈÄü -->
            <div class="relative w-80 h-40 flex items-center justify-center">
                <svg class="w-80 h-80 absolute -top-10 transform -rotate-180">
                    <circle cx="160" cy="160" r="140" stroke="rgba(51, 65, 85, 0.4)" stroke-width="14" fill="transparent" stroke-dasharray="880" stroke-dashoffset="440" stroke-linecap="round" />
                    <circle id="rpm-gauge" cx="160" cy="160" r="140" stroke="var(--truck-orange)" stroke-width="14" fill="transparent" stroke-dasharray="880" stroke-dashoffset="880" class="gauge-ring" stroke-linecap="round" />
                </svg>
                
                <!-- ÈÄüÂ∫¶ -->
                <div class="z-10 text-center translate-y-1">
                    <div class="text-7xl speedo-font font-bold leading-none tracking-tight" id="speed-val">99</div>
                    <div class="text-slate-400 text-xs mt-2 uppercase tracking-widest font-bold">km/h</div>
                </div>
            </div>

            <!-- ‰∏ãÊñπÊï∏ÊìöË≥áË®äÂçÄ -->
            <div class="w-full flex flex-col items-center">
                <!-- ÂÆöÈÄü | Ê™î‰Ωç | ÈÄüÈôê -->
                <div class="flex items-center justify-center space-x-10 h-14 -mt-8 mb-6">
                    <div id="cruise-container" class="flex items-center space-x-2 transition-all duration-300">
                        <div class="w-8 h-8 flex items-center justify-center">
                            <svg class="w-7 h-7 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        </div>
                        <span class="text-3xl font-bold text-emerald-400 speedo-font" id="cruise-val">85</span>
                    </div>

                    <div class="bg-slate-800 px-7 py-2 rounded-lg border border-slate-600 text-white shadow-xl min-w-[90px] text-center">
                        <div class="text-4xl font-bold speedo-font" id="gear-val">11</div>
                    </div>

                    <div id="limit-container" class="transition-all duration-300">
                        <div class="w-14 h-14 rounded-full border-[5px] border-red-600 bg-white text-black flex items-center justify-center font-bold text-2xl shadow-inner">
                            <span id="limit-val">80</span>
                        </div>
                    </div>
                </div>

                <!-- ÈáåÁ®ãËàáÈÅäÊà≤ÊôÇÈñì -->
                <div class="flex justify-center mt-6">
                    <div class="text-[17px] text-slate-400 font-bold tracking-tighter bg-slate-800/40 px-8 py-2 rounded-full border border-white/5 shadow-inner">
                        <span id="total-odo">66666km</span> 
                        <span class="mx-5 text-slate-600 font-normal">|</span> 
                        <span id="game-time" class="text-yellow-500">JC:YI</span> 
                        <span class="mx-5 text-slate-600 font-normal">|</span> 
                        <span id="trip-odo">999.9km</span>
                    </div>
                </div>
            </div>

            <!-- Ë≠¶Á§∫ÁáàÂçÄ -->
            <div class="w-full mt-4 pt-4 border-t border-slate-700/50 flex justify-center space-x-6">
                <span title="ËøëÂÖâÁáà" id="headlight-light" class="warning-light light-on-green">üí°</span>
                <span title="ÈÅ†ÂÖâÁáà" id="high-beam-light" class="warning-light">üî¶</span>
                <span title="ÊâãÁÖûËªä" id="brake-light" class="warning-light light-on-red">‚ìü</span>
                <span title="ÊïÖÈöúÁáà" id="engine-warning-light" class="warning-light">‚ö†Ô∏è</span>
                <span title="ÂºïÊìéÁáà" id="engine-light" class="warning-light light-on-green">‚öôÔ∏è</span>
            </div>
        </div>

        <!-- RHS Ë≥áË®äÂçÄ -->
        <div class="col-span-7 flex flex-col space-y-6">
            <div class="glass p-3 flex justify-between items-center px-6">
                <div class="speedo-font font-bold text-orange-500 tracking-wider text-lg">
                    TruckerM3U8
                    <span class="text-sm" id="version-code">-.-</span>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="game-badge" class="flex items-center space-x-1.5 text-xs font-bold px-3 py-1 rounded-full border border-slate-600 text-slate-500">
                        <span id="game-badge-dot" class="w-2 h-2 rounded-full bg-slate-600"></span>
                        <span id="game-badge-text">Disconnected</span>
                    </div>
                    <button class="hover:text-orange-500 transition text-sm font-bold" onclick="toggleTheme()">üåì</button>
                    <button class="hover:text-orange-500 transition text-sm font-bold" onclick="toggleInfoModal()">‚ÑπÔ∏è</button>
                </div>
            </div>

            <!-- Â∞èÂ∑•ÂÖ∑ÔºöÁõ£Ê∏¨ÂçÄÂüü -->
            <div class="grid grid-cols-2 gap-6">
                <div class="glass p-5">
                    <div class="widget-title">Áñ≤ÂãûÁõ£Ê∏¨</div>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-2xl font-bold" id="sleep-text">--h --m</span>
                        <span class="text-xs text-slate-400 pb-1">Ë∑ùÈõ¢‰ºëÊÅØ</span>
                    </div>
                    <div class="progress-bar"><div id="sleep-bar" class="progress-fill bg-orange-500" style="width: 0%;"></div></div>
                </div>
                <div class="glass p-5">
                    <div class="widget-title">ÁáÉÊ≤πÁãÄÊÖã</div>
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-2xl font-bold" id="fuel-text">0 L</span>
                        <span class="text-xs text-slate-400 pb-1">Ââ©È§òÊ≤πÈáè</span>
                    </div>
                    <div class="progress-bar"><div id="fuel-bar" class="progress-fill bg-orange-500" style="width: 0%;"></div></div>
                </div>
            </div>

            <!-- Â∞èÂ∑•ÂÖ∑ÔºöË°åÁ®ãÂ∞éËà™ -->
            <div class="glass p-6 flex-1 flex flex-col">
                <div class="widget-title">Ë°åÁ®ãÂ∞éËà™</div>
                <!-- Â∑•‰ΩúÁ∂±Ë¶Å -->
                <div id="cargo-card" class="mt-2 p-4 bg-slate-800/40 rounded-xl border border-emerald-500/20 flex items-center justify-between shadow-lg">
                    <div class="flex items-center space-x-4">
                        <div class="text-3xl" id="cargo-icon">Ôºü</div>
                        <div>
                            <div class="text-lg font-bold" id="cargo-name">-- <span class="text-sm text-slate-400 font-normal ml-1" id="cargo-mass">(- ÂÖ¨Âô∏)</span></div>
                            <div class="text-[11px] font-bold uppercase tracking-[0.2em] mt-0.5 flex items-center" id="cargo-destination">--</div>
                        </div>
                    </div>
                    <div class="text-xs font-bold px-3 py-1 rounded-full border" id="cargo-status">--</div>
                </div>
                <!-- Â∞éËà™Ë≥áË®ä -->
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="text-center p-3 bg-slate-800/30 rounded-lg border border-white/5">
                        <div class="text-xs text-slate-500 mb-1">ÁõÆÁöÑÂú∞Ë∑ùÈõ¢</div>
                        <div class="text-2xl font-bold" id="nav-distance">-- <small class="text-xs">km</small></div>
                    </div>
                    <div class="text-center p-3 bg-slate-800/30 rounded-lg border border-white/5">
                        <div class="text-xs text-slate-500 mb-1">ETA</div>
                        <div class="text-2xl font-bold" id="nav-eta">--:--</div>
                    </div>
                </div>
            </div>

            <!-- Â∞èÂ∑•ÂÖ∑ÔºöËªäÊêçÊ¶ÇË¶Å (ÂÑ™ÂåñÊéíÁâà) -->
            <div class="glass p-5">
                <div class="widget-title">ËªäËºõÊ¶ÇË¶Å</div>
                <div class="grid grid-cols-3 gap-4 mt-4">
                    <div class="text-center p-3 bg-slate-800/30 rounded-lg border border-white/5">
                        <div class="text-xs text-slate-500 mb-1 uppercase font-bold">ËªäËºõÊêçÂ£û (ÊúÄÂ§ß)</div>
                        <div class="text-2xl font-bold" id="damage-truck">-%</div>
                    </div>
                    <div class="text-center p-3 bg-slate-800/30 rounded-lg border border-white/5">
                        <div class="text-xs text-slate-500 mb-1 uppercase font-bold">ÊãñËªäÊêçÂ£û (ÊúÄÂ§ß)</div>
                        <div class="text-2xl font-bold" id="damage-trailer">-%</div>
                    </div>
                    <div class="text-center p-3 bg-slate-800/30 rounded-lg border border-white/5">
                        <div class="text-xs text-slate-500 mb-1 uppercase font-bold">Ë≤®Áâ©ÊêçÂ£û</div>
                        <div class="text-2xl font-bold" id="damage-cargo">-%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Èü≥Ê®ÇÊí≠ÊîæÂô® -->
    <div class="mt-6 glass p-4 flex items-center justify-between px-8 relative">
        <div class="flex items-center space-x-4">
            <div class="w-12 h-12 bg-slate-700 rounded-md flex items-center justify-center text-2xl shadow-inner">üìª</div>
            <div>
                <div class="text-[10px] text-slate-500 tracking-widest" id="radio-title">RADIO_TITLE</div>
                <div class="font-bold text-lg" id="radio-name">RADIO_NAME</div>
            </div>
        </div>
        <div class="flex items-center space-x-8">
            <button id="radio-prev" class="hover:text-orange-500 transition text-2xl">‚èÆ</button>
            <button id="play-pause" class="w-12 h-12 rounded-full bg-orange-500 text-white flex items-center justify-center hover:scale-105 transition shadow-lg shadow-orange-500/40 text-xl"><span id="play-icon">‚ñ∂</span></button>
            <button id="radio-next" class="hover:text-orange-500 transition text-2xl">‚è≠</button>
        </div>
        <div class="flex items-center">
            <button onclick="togglePlaylist()" class="flex items-center space-x-2 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg transition border border-white/10"><span class="text-sm font-bold">ÈõªÂè∞ÂàóË°®</span></button>
        </div>
    </div>

    <div id="playlist-modal" onclick="togglePlaylist()">
        <div class="glass w-full max-w-lg p-6 m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                <h3 class="text-xl font-bold">ÈõªÂè∞Ê∏ÖÂñÆ</h3>
                <button onclick="togglePlaylist()" class="text-2xl">√ó</button>
            </div>
            <div class="space-y-2 max-h-[60vh] overflow-y-auto pr-2" id="playlist-container"></div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="info-modal" onclick="toggleInfoModal()" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:50; align-items:center; justify-content:center;">
        <div class="glass w-full max-w-xl p-6 m-4" onclick="event.stopPropagation()" style="max-height:85vh; overflow-y:auto;">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <h3 class="text-xl font-bold">TruckerM3U8 Info</h3>
                <button onclick="toggleInfoModal()" class="text-2xl">√ó</button>
            </div>
            
            <div class="mb-5">
                <div class="text-sm font-bold text-orange-400 mb-2 uppercase tracking-wider">How to use</div>
                <p class="text-xs text-slate-400 mb-2">
                    TODO...
                </p>
            </div>

            <!-- Live Stream URL -->
            <div class="mb-5">
                <div class="text-sm font-bold text-orange-400 mb-2 uppercase tracking-wider">Add TruckerM3U8 URL into ETS2/ATS</div>
                <p class="text-xs text-slate-400 mb-2">Writes TruckerM3U8 URL into ETS2/ATS live stream list so you can play it ingame.</p>
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between"><span class="text-slate-400">ETS2</span><span id="info-ets2-stream" class="font-bold">Loading...</span></div>
                    <div class="flex justify-between"><span class="text-slate-400">ATS</span><span id="info-ats-stream" class="font-bold">Loading...</span></div>
                </div>
                <button id="info-apply-stream-btn" onclick="infoApplyLiveStream()" style="display:none" class="mt-2 w-full text-sm font-bold bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 px-4 py-2 rounded-lg border border-orange-500/30 transition">
                    Add TruckerM3U8 URL To Stream List
                </button>
            </div>

            <!-- Telemetry DLL -->
            <div class="mb-5">
                <div class="text-sm font-bold text-orange-400 mb-2 uppercase tracking-wider">Add Telemetry SDK into ETS2/ATS (Optional)</div>
                <p class="text-xs text-slate-400 mb-2">Telemetry SDK is used to get the game data and send it to the web page. You can still use the radio without telemetry installed.</p>
                <div class="space-y-1 text-sm">
                    <div class="flex justify-between"><span class="text-slate-400">ETS2</span><span id="info-ets2-telemetry" class="font-bold">Loading...</span></div>
                    <div class="flex justify-between"><span class="text-slate-400">ATS</span><span id="info-ats-telemetry" class="font-bold">Loading...</span></div>
                </div>
                <button id="info-apply-telemetry-btn" onclick="infoApplyTelemetryDll()" style="display:none" class="mt-2 w-full text-sm font-bold bg-orange-500/20 hover:bg-orange-500/30 text-orange-400 px-4 py-2 rounded-lg border border-orange-500/30 transition">
                    Install Telemetry DLL
                </button>
            </div>

            <!-- Troubleshoot -->
            <div class="mb-5">
                <div class="text-sm font-bold text-orange-400 mb-2 uppercase tracking-wider">Doesn't work?</div>
                <p class="text-xs text-slate-400">Try download newer FFMPEG version from <a href="https://www.gyan.dev/ffmpeg/builds/ffmpeg-git-essentials.7z" class="text-orange-400 underline" target="_blank">here</a>. Simply replace <code class="bg-slate-700 px-1 rounded">ThirdParty/ffmpeg.exe</code>.</p>
            </div>

            <!-- Version -->
            <div class="text-xs text-slate-500 border-t border-slate-700 pt-3 flex justify-between items-center">
                <span id="info-version">v.--</span>
                <a href="https://github.com/JCxYIS/TruckerM3U8/releases/latest" target="_blank" class="text-orange-400 underline">Check latest version</a>
            </div>
        </div>
    </div>

    </div><!-- /#viewport -->

    <script>
        let radioListData = [];
        let isDark = true;
        const useMockData = false;  // use "fake" data to simulate?
        let connectedGame = undefined;  // `Ets2` | `Ats` | `mocked`
        let data = {
            speed: 0,
            gear: `N`,
            cruiseSpeed: 0,
            speedLimit: 0,

            totalOdo: 0,
            time: 0,  // Current Game Time. in min
            tripOdo: 0,
            rpm: 0,
            rpmMax: 0,
            
            leftIndicator: false,
            rightIndicator: false,
            beamLow: false,
            beamHigh: false,
            parkingBrake: false,
            warning: false,
            engineEnabled: false,

            nextRestStopValue: 0,  // Next rest time (in minutes)
            fuelAmount: 0,
            fuelCapacity: 1000,

            onjob: false,  // is the user currently on a job?
            isSpecialJob: false,
            cargoName: "",
            cargoMass: 5000,  // Mass in kilograms
            cityDestination: "",
            navigationDistance: 0,  //  The value of truck's navigation distance (in meters)
            navigationTime: 0,  // The value of truck's navigation eta (in second)

            damageTruck: 0,  // The value of truck's damage (in percentage)
            damageTrailer: 0,  // The value of trailer's damage (in percentage)
            damageCargo: 0,  // The value of cargo's damage (in percentage, if any)
        };



        function togglePlaylist() {
            const modal = document.getElementById('playlist-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        function toggleTheme() {
            isDark = !isDark;
            document.getElementById('app-body').classList.toggle('light-theme');
        }

        function toggleInfoModal() {
            const modal = document.getElementById('info-modal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }
        toggleInfoModal();

        // UI rendering ‚Äî writes `data` to DOM
        function updateUI() {
            // === Connection badge ===
            const badgeDot = document.getElementById('game-badge-dot');
            const badgeText = document.getElementById('game-badge-text');
            const badge = document.getElementById('game-badge');
            if (connectedGame || useMockData) {
                const label = connectedGame ? connectedGame.toUpperCase() : 'Mocked';
                badgeText.innerText = label;
                badgeDot.className = 'w-2 h-2 rounded-full bg-emerald-400 animate-pulse';
                badge.className = 'flex items-center space-x-1.5 text-xs font-bold px-3 py-1 rounded-full border border-emerald-500/30 text-emerald-400';
            } else {
                badgeText.innerText = 'Disconnected';
                badgeDot.className = 'w-2 h-2 rounded-full bg-slate-600';
                badge.className = 'flex items-center space-x-1.5 text-xs font-bold px-3 py-1 rounded-full border border-slate-600 text-slate-500';
            }
            // === Speedometer cluster ===
            document.getElementById('speed-val').innerText = Math.round(data.speed);
            document.getElementById('gear-val').innerText = data.gear===0?'N': data.gear<0?`R${Math.abs(data.gear)}`: data.gear;
            document.getElementById('total-odo').innerText = Math.floor(data.totalOdo) + 'km';
            document.getElementById('trip-odo').innerText = data.tripOdo.toFixed(1) + 'km';

            const cruiseContainer = document.getElementById('cruise-container');
            if (data.cruiseSpeed > 0) {
                cruiseContainer.style.opacity = "1";
                document.getElementById('cruise-val').innerText = Math.round(data.cruiseSpeed);
            } else {
                cruiseContainer.style.opacity = "0";
            }

            const limitContainer = document.getElementById('limit-container');
            if (data.speedLimit > 0) {
                limitContainer.style.opacity = "1";
                document.getElementById('limit-val').innerText = Math.round(data.speedLimit);
            } else {
                limitContainer.style.opacity = "0";
            }

            let timeH = Math.floor(data.time%1440/60);
            let timeM = Math.floor(data.time%60);
            document.getElementById('game-time').innerText = `${String(timeH).padStart(2, '0')}:${String(timeM).padStart(2, '0')}`;  

            const rpmPercent = Math.min(data.rpm / data.rpmMax, 1);
            document.getElementById('rpm-gauge').style.strokeDashoffset = 880 - (440 * rpmPercent);

            // === Warning lights ===
            toggleLight('brake-light', data.parkingBrake, 'light-on-red');
            toggleLight('indicator-left', data.leftIndicator, 'indicator-active');
            toggleLight('indicator-right', data.rightIndicator, 'indicator-active');
            toggleLight('engine-light', data.engineEnabled, 'light-on-green');
            toggleLight('headlight-light', data.beamLow, 'light-on-green');
            toggleLight('high-beam-light', data.beamHigh, 'light-on-blue');
            toggleLight('engine-warning-light', data.warning, 'light-on-red');

            // === Fatigue / Rest stop ===
            let nextRestH = Math.floor(data.nextRestStopValue/60);
            let nextRestM = Math.floor(data.nextRestStopValue%60);
            document.getElementById('sleep-text').innerText = `${String(nextRestH).padStart(2, '0')}:${String(nextRestM).padStart(2, '0')}`;
            const restPercent = Math.min(100, Math.max(0, (60*nextRestH + nextRestM) / (11 * 60) * 100));  // 11h max drive time
            document.getElementById('sleep-bar').style.width = restPercent + '%';

            // === Fuel ===
            document.getElementById('fuel-text').innerText = Math.round(data.fuelAmount) + ' L';
            const fuelPercent = data.fuelCapacity > 0 ? (data.fuelAmount / data.fuelCapacity * 100) : 0;
            document.getElementById('fuel-bar').style.width = Math.round(fuelPercent) + '%';

            // === Cargo / Navigation ===
            const onJob = data.onjob;
            const isSpecial = onJob && data.isSpecialJob;
            // Pick theme: no job = green, special = red, normal = orange
            const jobColor = !onJob ? 'emerald' : isSpecial ? 'red' : 'orange';

            document.getElementById('cargo-card').className = `mt-2 p-4 bg-slate-800/40 rounded-xl border border-${jobColor}-500/20 flex items-center justify-between shadow-lg`;
            document.getElementById('cargo-icon').innerText = !onJob ? 'üó∫Ô∏è' : isSpecial ? 'üöß' : 'üì¶';
            document.getElementById('cargo-name').innerHTML = onJob
                ? `${data.cargoName} <span class="text-sm text-slate-400 font-normal ml-1">(${(data.cargoMass / 1000).toFixed(1)} ÂÖ¨Âô∏)</span>`
                : '--';
            document.getElementById('cargo-destination').innerText = data.onjob ? `ÂæÄ${data.cityDestination}` : '--';
            document.getElementById('cargo-destination').className = `text-[11px] text-${jobColor}-400 font-bold uppercase tracking-[0.2em] mt-0.5 flex items-center`;
            const statusEl = document.getElementById('cargo-status');
            statusEl.innerText = !onJob ? 'ÁÑ°Â∑•‰Ωú' : isSpecial ? 'ÁâπÊÆäÂ∑•‰Ωú' : 'Â∑•‰Ωú‰∏≠';
            statusEl.className = `text-xs text-${jobColor}-500 font-bold bg-${jobColor}-500/10 px-3 py-1 rounded-full border border-${jobColor}-500/30`;

            const navKm = (data.navigationDistance / 1000);
            document.getElementById('nav-distance').innerHTML = navKm > 0 ? `${Math.round(navKm)} <small class="text-xs">km</small>` : '--';
            const etaH = Math.floor(data.navigationTime / 3600);
            const etaM = Math.floor((data.navigationTime % 3600) / 60);
            document.getElementById('nav-eta').innerText = data.navigationTime > 0 ? `${String(etaH).padStart(2, '0')}:${String(etaM).padStart(2, '0')}` : '--:--';

            // === Damage ===
            updateDamageCell('damage-truck', data.damageTruck);
            updateDamageCell('damage-trailer', data.damageTrailer);
            if(onJob) updateDamageCell('damage-cargo', data.damageCargo);
            else {
              document.getElementById('damage-cargo').innerText = '--';
              document.getElementById('damage-cargo').className = 'text-2xl font-bold text-slate-400';
            }
        }

        function toggleLight(id, isOn, className) {
            const el = document.getElementById(id);
            if (isOn) el.classList.add(className);
            else el.classList.remove(className);
        }

        function updateDamageCell(id, value) {
            const el = document.getElementById(id);
            const pct = Math.round(value * 100);
            el.innerText = pct + '%';
            el.className = 'text-2xl font-bold ' + (pct < 10 ? 'text-emerald-400' : pct < 30 ? 'text-yellow-400' : 'text-red-400');
        }

        setInterval(() => { updateUI(); }, 100);        
    </script>

    <!-- Mock Data -->
    <script>
      if(useMockData) {
        // Mock data generation ‚Äî pure data, no DOM touching
        function updateMockData() {
            if(data.engineEnabled) {
              data.speed += (Math.random() * 1.1 - 0.1);
              data.rpm = Math.min(1000 + (data.speed * 10) + (Math.random() * 50), data.rpmMax);
              data.gear = data.speed > 80 ? '12' : (data.speed > 5 ? Math.floor(data.speed / 7) + 1 : 'N');
              data.fuelAmount -= 0.1;
            }
            else {
              data.speed -= 0.25;
              data.rpm = 0;
              data.gear = 'N';
            }
            if(data.parkingBrake)
              data.speed -= 2;
            if (data.speed < 0) data.speed = 0;
            if(data.fuelAmount < 0) data.fuelAmount = 0;

            const increment = data.speed * 0.001;
            data.totalOdo += increment;
            data.tripOdo += increment;  
            data.time += 0.05; 
            data.nextRestStopValue -= 0.05;
        }
        
        data.rpmMax = 2500;
        data.totalOdo = Math.random() * 100000;
        data.tripOdo = Math.random() * data.totalOdo;
        data.fuelCapacity = 1000;
        data.fuelAmount = Math.random() * data.fuelCapacity;
        data.nextRestStopValue = (Math.random()*11) * 60;

        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 's') data.speedLimit = data.speedLimit === 0 ? 80 : 0;
            if (e.key.toLowerCase() === 'c') data.cruiseSpeed = data.cruiseSpeed === 0 ? 85 : 0;
            if (e.key.toLowerCase() === 'e') data.engineEnabled = !data.engineEnabled;
            if (e.key.toLowerCase() === 'i') data.tripOdo = 0;
            if (e.key.toLowerCase() === '[') data.leftIndicator = !data.leftIndicator;
            if (e.key.toLowerCase() === ']') data.rightIndicator = !data.rightIndicator;
            if (e.key.toLowerCase() === 'f') data.fuelAmount = Math.random() * data.fuelCapacity;
            if (e.key.toLowerCase() === 'r') data.nextRestStopValue = (Math.random()*11) * 60;
            if (e.key.toLowerCase() === 'j') {
                data.cargoName = data.onJob ? "" : "Âπ∏Á¶è";
                data.isSpecialJob = data.onJob ? false : Math.random()>0.5;
                data.cargoMass = data.onJob ? 0 : Math.floor(Math.random() * 20)*1000 + 1000;
                data.cityDestination = data.onJob ? "xxx" : "Á∂úËóùÂ§ßÈõÜÂêà";
                data.navigationDistance = data.onJob ? 0 : Math.floor(Math.random() * 1000)*1000 + 1000;
                data.navigationTime = data.onJob ? 0 : Math.floor(Math.random()*55 * 3600) + 60;
                data.onjob = !data.onjob;
            }
            if(e.key.toLowerCase() === 'd') {
              data.damageTruck = Math.random();
              data.damageTrailer = Math.random();
              data.damageCargo = Math.random();
            }
            if (e.key               === ' ') data.parkingBrake = !data.parkingBrake;
        });

        setInterval(() => { updateMockData(); }, 100);
      }
    </script>

    <!-- Real Data -->
    <script>
      if (!useMockData) {
        let tripOdoBase = null;  // first odometer reading, used to calculate trip delta

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/telemetryHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveTelemetry", t => {
            connectedGame = t.game;  // 'Ets2' | 'Ats'

            // --- Speedometer cluster ---
            data.speed = Math.abs(t.speedKph);
            data.gear = t.gearDashboard;
            data.cruiseSpeed = t.cruiseControlActive ? Math.abs(t.cruiseControlSpeedKph) : 0;
            data.speedLimit = Math.abs(t.speedLimitKph);

            // --- Odometer / Time ---
            data.totalOdo = t.odometer;
            if (tripOdoBase === null) tripOdoBase = t.odometer;
            data.tripOdo = t.odometer - tripOdoBase;

            // GameTime = total in-game minutes (uint). Only HH:mm matters.
            data.time = t.gameTime;

            // --- Engine ---
            data.rpm = t.rpm;
            data.rpmMax = t.engineRpmMax;
            data.engineEnabled = t.engineEnabled;

            // --- Indicators & Lights ---
            data.leftIndicator = t.blinkerLeftOn;
            data.rightIndicator = t.blinkerRightOn;
            data.beamLow = t.beamLow;
            data.beamHigh = t.beamHigh;
            data.parkingBrake = t.parkingBrake;

            // --- Warnings (any warning = on) ---
            data.warning = t.warningAirPressure || t.warningAirPressureEmergency
                || t.warningFuel || t.warningAdBlue
                || t.warningOilPressure || t.warningWaterTemperature
                || t.warningBatteryVoltage;

            // --- Fatigue ---
            // NextRestStop is a Frequency object { value: int_minutes_until_rest }
            data.nextRestStopValue = t.nextRestStop?.value ?? 0;

            // --- Fuel ---
            data.fuelAmount = t.fuelAmount;
            data.fuelCapacity = t.fuelCapacity;

            // --- Job / Cargo ---
            data.cargoName = t.cargoName || "";
            data.cargoMass = t.cargoMass || 0;
            data.onjob = t.onJob;
            data.isSpecialJob = t.isSpecialJob;
            data.cityDestination = t.cityDestination || "";

            // --- Navigation ---
            data.navigationDistance = t.navigationDistance;
            data.navigationTime = t.navigationTime;

            // --- Damage ---            
            data.damageTruck = Math.max(t.damageEngine, t.damageTransmission, t.damageCabin, t.damageChassis, t.damageWheels);  // TODO how to calc?
            data.damageTrailer = Math.max(t.trailer0DamageBody, t.trailer0DamageChassis, t.trailer0DamageWheels);
            data.damageCargo = t.cargoDamage;
        });

        connection.onreconnecting(() => console.log('[Dashboard] SignalR reconnecting...'));
        connection.onreconnected(() => console.log('[Dashboard] SignalR reconnected'));
        connection.onclose(() => { connectedGame = undefined; console.log('[Dashboard] SignalR closed'); });
        connection.start()
            .then(() => console.log('[Dashboard] SignalR connected'))
            .catch(err => console.error('[Dashboard] SignalR error:', err));

        // Reset trip odometer with 'i' key
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'i') tripOdoBase = data.totalOdo;
        });
      }
    </script>

    <!-- uniform scaling -->
    <script>
      // Fixed-viewport scaling: fit 1200√ó800 into any screen
      function scaleViewport() {
          const vp = document.getElementById('viewport');
          const scaleX = window.innerWidth / 1200;
          const scaleY = window.innerHeight / 800;
          const scale = Math.min(scaleX, scaleY);
          vp.style.transform = `scale(${scale})`;
          // Center if there's leftover space on one axis
          const offsetX = (window.innerWidth - 1200 * scale) / 2;
          const offsetY = (window.innerHeight - 800 * scale) / 2;
          vp.style.left = offsetX + 'px';
          vp.style.top = offsetY + 'px';
      }
      window.addEventListener('resize', scaleViewport);
      scaleViewport();
    </script>

    <!-- Radio Player -->
    <script>
      let currentRadioUrl = '';
      let radioIsPlaying = false;

      // --- Fetch radio list from API ---
      async function fetchRadioList() {
          try {
              const resp = await fetch('/api/playback/radiolist');
              radioListData = await resp.json();
              renderPlaylist();
              updateRadioUI();
          } catch (e) {
              console.error('[Radio] Failed to fetch radio list:', e);
          }
      }

      // --- Fetch current playing station ---
      async function fetchCurrentPlaying() {
          try {
              const resp = await fetch('/sourceUrl');
              const url = await resp.text();
              currentRadioUrl = url.trim();
              radioIsPlaying = !!currentRadioUrl;
              updateRadioUI();
          } catch (e) {
              console.error('[Radio] Failed to fetch current playing:', e);
          }
      }

      // --- Send play request ---
      async function playStation(url) {
          try {
              await fetch('/sourceUrl', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: `"${url}"`
              });
              currentRadioUrl = url;
              radioIsPlaying = true;
              updateRadioUI();
              renderPlaylist();
          } catch (e) {
              console.error('[Radio] Failed to play:', e);
          }
      }

      // --- Stop playback (send empty URL) ---
      async function stopPlayback() {
          try {
              await fetch('/sourceUrl', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: '""'
              });
              currentRadioUrl = '';
              radioIsPlaying = false;
              updateRadioUI();
              renderPlaylist();
          } catch (e) {
              console.error('[Radio] Failed to stop:', e);
          }
      }

      // --- Get current station index ---
      function currentStationIndex() {
          return radioListData.findIndex(s => s.url === currentRadioUrl);
      }

      // --- Prev / Next ---
      function playPrev() {
          if (radioListData.length === 0) return;
          let idx = currentStationIndex();
          idx = (idx <= 0) ? radioListData.length - 1 : idx - 1;
          playStation(radioListData[idx].url);
      }

      function playNext() {
          if (radioListData.length === 0) return;
          let idx = currentStationIndex();
          idx = (idx < 0 || idx >= radioListData.length - 1) ? 0 : idx + 1;
          playStation(radioListData[idx].url);
      }

      // --- Update radio label & play/pause icon ---
      function updateRadioUI() {
          const titleEl = document.getElementById('radio-title');
          const nameEl = document.getElementById('radio-name');
          const iconEl = document.getElementById('play-icon');
          const station = radioListData.find(s => s.url === currentRadioUrl);
          titleEl.innerText = (radioIsPlaying ? currentRadioUrl : 'IN GAME RADIO');
          nameEl.innerText = station ? station.name : (radioIsPlaying ? 'Êú™ÂëΩÂêçÈõªÂè∞' : '---');
          iconEl.innerText = radioIsPlaying ? '\u23f8' : '\u25b6';
      }

      // --- Render playlist modal entries ---
      function renderPlaylist() {
          const container = document.getElementById('playlist-container');
          container.innerHTML = '';
          radioListData.forEach(s => {
              const div = document.createElement('div');
              const isActive = s.url === currentRadioUrl;
              div.className = `flex justify-between items-center p-3 rounded-lg cursor-pointer transition border group ${
                  isActive
                      ? 'bg-orange-500/20 border-orange-500/50'
                      : 'hover:bg-orange-500/20 border-transparent hover:border-orange-500/50'
              }`;
              div.onclick = () => { playStation(s.url); togglePlaylist(); };
              div.innerHTML = `<div><div class="font-bold ${isActive ? 'text-orange-400' : 'group-hover:text-orange-400'}">${s.name}</div><div class="text-[10px] text-slate-500">${s.url}</div></div><span class="text-orange-500 ${isActive ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}">${isActive ? '\u23f8' : '\u25b6'}</span>`;
              container.appendChild(div);
          });
      }

      // --- Wire up buttons ---
      document.getElementById('play-pause').onclick = () => {
          if (radioIsPlaying) {
              stopPlayback();
          } else {
              // Resume: play current or first station
              const url = currentRadioUrl || (radioListData.length > 0 ? radioListData[0].url : '');
              if (url) playStation(url);
          }
      };
      document.getElementById('radio-prev').onclick = playPrev;
      document.getElementById('radio-next').onclick = playNext;

      fetchRadioList();
      fetchCurrentPlaying();
    </script>

    <!-- Info Modal Logic -->
    <script>
      const infoStateText = (state) => {
          switch (state) {
              case -1: return '‚ùì Not found';
              case  0: return '\u26a0\ufe0f Missing';
              case  1: return '\u2705 OK';
              default: return 'Unknown';
          }
      };

      async function infoFetchStreamCheck() {
          try {
              const resp = await fetch('/api/fileCheck/liveStreamListCheck');
              const d = await resp.json();
              document.getElementById('info-ets2-stream').textContent = infoStateText(d.ets2);
              document.getElementById('info-ats-stream').textContent = infoStateText(d.ats);
              document.getElementById('info-apply-stream-btn').style.display =
                  (d.ets2 === 0 || d.ats === 0) ? '' : 'none';
          } catch (e) {
              console.error('[Info] Stream check failed:', e);
          }
      }

      async function infoApplyLiveStream() {
          if (!confirm('Add TruckerM3U8 URL to your ETS2/ATS live stream list?')) return;
          await fetch('/api/fileCheck/liveStreamListApply');
          infoFetchStreamCheck();
      }

      async function infoFetchTelemetryCheck() {
          try {
              const resp = await fetch('/api/fileCheck/telemetryDllCheck');
              const d = await resp.json();
              document.getElementById('info-ets2-telemetry').textContent = infoStateText(d.ets2);
              document.getElementById('info-ats-telemetry').textContent = infoStateText(d.ats);
              document.getElementById('info-apply-telemetry-btn').style.display =
                  (d.ets2 === 0 || d.ats === 0) ? '' : 'none';
          } catch (e) {
              console.error('[Info] Telemetry check failed:', e);
          }
      }

      async function infoApplyTelemetryDll() {
          if (!confirm('Install Telemetry DLL into ETS2/ATS?')) return;
          await fetch('/api/fileCheck/telemetryDllApply');
          infoFetchTelemetryCheck();
      }

      async function infoFetchVersion() {
          try {
              const resp = await fetch('/version');
              const ver = await resp.text();
              document.getElementById('version-code').textContent = ver;
              document.getElementById('info-version').textContent = 'v.' + ver;
          } catch (e) {
              console.error('[Info] Version fetch failed:', e);
          }
      }

      // Fetch all info on page load
      infoFetchStreamCheck();
      infoFetchTelemetryCheck();
      infoFetchVersion();
    </script>
    
</body>
</html>